import{o as N,h as q,r as i,j as e,L as g,q as D,s as R,t as S,v as L,l as k}from"./main-CYDXynsJ.js";function B(){const{listings:t}=N.useLoaderData(),n=q.useSession().data?.user.id,[d,c]=i.useState(!1),[o,f]=i.useState(null),[b,p]=i.useState(null),u=!!n,[v,m]=i.useState(()=>new Set(t.filter(s=>s.viewerHasRequested).map(s=>s.id)));i.useEffect(()=>{if(!u){c(!1),m(new Set);return}let s=!1;return(async()=>{try{const r=await D();s||c(r.isDriver)}catch(r){s||(console.error("[driver-status] Unable to fetch status",r),c(!1))}})(),()=>{s=!0}},[u]),i.useEffect(()=>{if(!(u&&d))return;let a=!1;return(async()=>{try{const l=await R();a||m(new Set(l))}catch(l){a||console.error("[driver-request] Unable to fetch",l)}})(),()=>{a=!0}},[d,u]);const j=async(s,a)=>{f(s),p(null),m(r=>{const l=new Set(r);return a?l.delete(s):l.add(s),l});try{const r=a?await S(s):await L(s);p({type:"success",message:r.message??"Action effectuée.",listingId:s})}catch(r){m(w=>{const h=new Set(w);return a?h.add(s):h.delete(s),h});const l=r instanceof Error?r.message:"Impossible de traiter votre demande.";p({type:"error",message:l,listingId:s})}finally{f(null)}},y=u&&d;return e.jsxs("section",{className:"space-y-6 p-4",children:[e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm uppercase tracking-wide text-slate-500",children:"Explorer"}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Tous les listings"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(g,{to:"/mes-listings",className:"rounded-md border border-slate-300 px-4 py-2 text-slate-700 transition hover:bg-slate-50",children:"Voir mes listings"}),e.jsx(g,{to:"/listings/new",className:"rounded-md bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800",children:"Créer un listing"})]})]}),e.jsx("div",{className:"rounded-md border border-slate-200 bg-white p-4 text-sm text-slate-600",children:"Cette page est accessible sans compte pour parcourir les derniers listings publiés."}),t.length===0?e.jsx("p",{className:"text-sm text-slate-500",children:"Aucun listing public n’est disponible pour le moment."}):e.jsx("ul",{className:"space-y-4",children:t.map(s=>{const a=v.has(s.id),r=y&&s.ownerId!==void 0&&s.ownerId!==n&&s.status==="published";return e.jsx(E,{listing:s,canRequestDelivery:r,hasRequested:a,onRequestDelivery:()=>j(s.id,a),requesting:o===s.id,feedback:b?.listingId===s.id?b:null},s.id)})})]})}function E({listing:t,canRequestDelivery:x,hasRequested:n,onRequestDelivery:d,requesting:c,feedback:o}){return e.jsxs("li",{className:"rounded-lg border border-slate-200 bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-slate-900",children:t.title}),t.shortDescription&&e.jsx("p",{className:"text-sm text-slate-500",children:t.shortDescription})]}),e.jsxs("div",{className:"flex flex-col items-end gap-2",children:[e.jsx(A,{status:t.status}),x&&e.jsxs("div",{className:"flex flex-col items-end gap-1",children:[e.jsx("button",{type:"button",onClick:d,disabled:c,className:"rounded-md border border-slate-300 px-3 py-1 text-sm font-medium text-slate-700 transition hover:bg-slate-50 disabled:cursor-not-allowed disabled:text-slate-400",children:c?"Envoi…":n?"Annuler la demande":"Demander à livrer"}),o&&e.jsx("p",{className:`text-xs ${o.type==="success"?"text-emerald-600":"text-rose-600"}`,children:o.message})]})]})]}),e.jsxs("div",{className:"mt-4 grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Retrait"}),e.jsx("p",{className:"text-sm text-slate-800",children:t.pickupAddress})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Livraison"}),e.jsx("p",{className:"text-sm text-slate-800",children:t.deliveryAddress})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Budget estimé"}),e.jsx("p",{className:"text-lg font-semibold text-slate-900",children:C(t)})]})]})]})}function A({status:t}){const x=k[t],n={draft:"bg-slate-200 text-slate-800",published:"bg-emerald-100 text-emerald-700",assigned:"bg-indigo-100 text-indigo-700",ready_for_pickup:"bg-yellow-100 text-yellow-800",in_transit:"bg-blue-100 text-blue-800",delivered:"bg-green-100 text-green-700",cancelled:"bg-rose-100 text-rose-700",disputed:"bg-orange-100 text-orange-700",archived:"bg-slate-100 text-slate-500"};return e.jsx("span",{className:`inline-flex items-center rounded-full px-3 py-1 text-sm font-medium ${n[t]}`,children:x})}function C(t){return!t.budget||!t.currency?"À définir":new Intl.NumberFormat("fr-FR",{style:"currency",currency:t.currency,maximumFractionDigits:0}).format(t.budget)}export{B as component};
