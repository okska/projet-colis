import{r as o,j as r,w as U,h as I,L as V,x as G}from"./main-CYDXynsJ.js";const B=x=>structuredClone(x);function H(x){const{validators:m,defaultValues:d,onSubmit:g}=x,l=o.useRef(m??{}),b=o.useRef(g),u=o.useRef(B(d)),[a,v]=o.useState(()=>B(u.current)),[E,e]=o.useState({}),t=o.useRef({}),[s,n]=o.useState({}),[M,R]=o.useState(!1),[T,F]=o.useState(0),A=o.useRef(null);o.useEffect(()=>{l.current=m??{}},[m]),o.useEffect(()=>{b.current=g},[g]);const k=o.useCallback(i=>{e(c=>{const p=i(c);return t.current=p,p})},[]),C=o.useCallback((i,c,p)=>{const f=l.current?.[i];if(!f)return[];const h=f(c,p??a);return h?[h]:[]},[a]),L=o.useCallback(()=>{const i=B(u.current);v(i),n({}),k(()=>({})),F(0)},[k]),q=o.useCallback((i,c)=>{v(p=>({...p,[i]:c}))},[]),O=o.useCallback(async i=>{i?.preventDefault();const c=a,p={};let f=!1;for(const h of Object.keys(c)){const y=C(h,c[h],c);y.length&&(f=!0,p[h]=y)}if(n(p),k(h=>{const y={...h};for(const S of Object.keys(c))y[S]=!0;return y}),F(h=>h+1),!f){R(!0);try{await b.current?.({value:c,formApi:A.current})}finally{R(!1)}}},[k,C,a]),z=({name:i,children:c})=>{const p=a[i],f=t.current[i]??!1,h=s[i]??[],y=()=>{k(j=>({...j,[i]:!0})),n(j=>({...j,[i]:C(i,a[i],a)}))},S=j=>{v(w=>{const W={...w,[i]:j};return t.current[i]&&n($=>({...$,[i]:C(i,j,W)})),W})};return r.jsx(r.Fragment,{children:c({name:i,state:{value:p,meta:{isDirty:!Object.is(p,u.current[i]),isTouched:f,touchedErrors:f?h:[]}},handleBlur:y,handleChange:S,setValue:j=>{v(w=>({...w,[i]:j}))}})})},P=o.useMemo(()=>Object.keys(u.current).some(c=>!Object.is(a[c],u.current[c])),[a]),D={Field:z,handleSubmit:O,reset:L,setFieldValue:q,state:{values:a,errors:s,touched:E,isDirty:P,isSubmitting:M,submitCount:T}};return A.current=D,D}function J(x){const m=H(x),d=o.useRef(m);d.current=m;const g=({selector:a,children:v})=>{const E=a(d.current.state);return r.jsx(r.Fragment,{children:v(E)})},l=o.useRef(null),b=o.useRef(null);l.current||(l.current=(a=>d.current.Field(a))),b.current||(b.current=g);const u=o.useRef(null);return u.current?(Object.assign(u.current,m),u.current.Field=l.current,u.current.Subscribe=b.current):u.current={...m,Field:l.current,Subscribe:b.current},u.current}function Q(){const x=U(),d=I.useSession().data?.user,g={title:"Titre",shortDescription:"Description rapide",pickupAddress:"Adresse de retrait",deliveryAddress:"Adresse de livraison",budget:"Budget estimé",currency:"Devise",pickupWindowStart:"Début de fenêtre de retrait",pickupWindowEnd:"Fin de fenêtre de retrait"},l=e=>`w-full rounded-md border px-3 py-2 transition ${e?"border-rose-400 focus-visible:outline-rose-500 focus-visible:ring-1 focus-visible:ring-rose-500":"border-slate-300 focus-visible:outline-slate-900 focus-visible:ring-1 focus-visible:ring-slate-300"}`,[b,u]=o.useState({intent:null}),a=J({defaultValues:{title:"",shortDescription:"",pickupAddress:"",deliveryAddress:"",budget:"50",currency:"EUR",pickupWindowStart:"",pickupWindowEnd:""},validators:{title:e=>e.trim().length===0?"Le titre est requis.":void 0,pickupAddress:e=>e.trim().length===0?"Adresse de retrait requise.":void 0,deliveryAddress:e=>e.trim().length===0?"Adresse de livraison requise.":void 0,budget:e=>Number(e)>0?void 0:"Le budget doit être supérieur à 0.",pickupWindowStart:(e,t)=>{if(!e||!t.pickupWindowEnd)return;const s=Date.parse(e),n=Date.parse(t.pickupWindowEnd);return Number.isNaN(s)||Number.isNaN(n)?"Fenêtre de retrait invalide.":s<n?void 0:"Le début doit être antérieur à la fin."},pickupWindowEnd:(e,t)=>{if(!e||!t.pickupWindowStart)return;const s=Date.parse(t.pickupWindowStart),n=Date.parse(e);return Number.isNaN(s)||Number.isNaN(n)?"Fenêtre de retrait invalide.":n>s?void 0:"La fin doit être postérieure au début."}},onSubmit:async({value:e,formApi:t})=>{if(!d){u({intent:"error",text:"Veuillez vous connecter pour créer un listing."});return}u({intent:null});const s={title:e.title.trim(),shortDescription:e.shortDescription?.trim()||void 0,pickupAddress:e.pickupAddress.trim(),deliveryAddress:e.deliveryAddress.trim(),budget:Number(e.budget)||0,currency:e.currency,pickupWindowStart:e.pickupWindowStart||void 0,pickupWindowEnd:e.pickupWindowEnd||void 0},n=await G(s);u({intent:n.ok?"success":"error",text:n.message}),n.ok&&(t.reset(),setTimeout(()=>{x({to:"/listings"})},350))}}),v=a.state.submitCount>0?Object.entries(a.state.errors).flatMap(([e,t])=>(t??[]).map(s=>({field:e,message:s}))):[],E=v.length>0;return r.jsxs("section",{className:"space-y-6 p-4",children:[r.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3",children:[r.jsxs("div",{children:[r.jsx("p",{className:"text-sm text-slate-500 uppercase tracking-wide",children:"Nouveau listing"}),r.jsx("h1",{className:"text-2xl font-semibold",children:"Publier une livraison"})]}),r.jsx(V,{to:"/listings",className:"rounded-md border border-slate-300 px-4 py-2 text-slate-700 transition hover:bg-slate-50",children:"Retour aux listings"})]}),d?null:r.jsxs("div",{className:"rounded-md border border-amber-300 bg-amber-50 p-4 text-sm text-amber-900",children:["Vous devez être connecté pour publier une livraison. Rendez-vous sur"," ",r.jsx(V,{to:"/auth",className:"font-medium underline",children:"la page d’authentification"})," ","pour créer un compte ou vous connecter."]}),r.jsxs("form",{onSubmit:e=>{a.handleSubmit(e)},className:"space-y-6 rounded-lg border border-slate-200 bg-white p-6 shadow-sm",children:[r.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[r.jsx(a.Field,{name:"title",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Titre",required:!0,error:t,children:r.jsx("input",{type:"text",value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s),placeholder:"Colis Bordeaux → Toulouse"})})}}),r.jsx(a.Field,{name:"budget",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Budget estimé (EUR)",required:!0,error:t,children:r.jsx("input",{type:"number",min:1,step:5,value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s)})})}})]}),r.jsx(a.Field,{name:"shortDescription",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Description rapide",error:t,children:r.jsx("textarea",{value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,rows:3,className:l(s),placeholder:"Précisez la nature du colis, sa fragilité, les documents à fournir..."})})}}),r.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[r.jsx(a.Field,{name:"pickupAddress",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Adresse de retrait",required:!0,error:t,children:r.jsx("input",{type:"text",value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s),placeholder:"12 Rue de la République, 69002 Lyon"})})}}),r.jsx(a.Field,{name:"deliveryAddress",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Adresse de livraison",required:!0,error:t,children:r.jsx("input",{type:"text",value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s),placeholder:"5 Rue Sainte-Catherine, 33000 Bordeaux"})})}})]}),r.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[r.jsx(a.Field,{name:"pickupWindowStart",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Début de fenêtre de retrait",error:t,children:r.jsx("input",{type:"datetime-local",value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s)})})}}),r.jsx(a.Field,{name:"pickupWindowEnd",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Fin de fenêtre de retrait",error:t,children:r.jsx("input",{type:"datetime-local",value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s)})})}})]}),r.jsx(a.Field,{name:"currency",children:e=>{const t=e.state.meta.touchedErrors[0],s=!!t;return r.jsx(N,{label:"Devise",error:t,children:r.jsxs("select",{value:e.state.value,onChange:n=>e.handleChange(n.target.value),onBlur:e.handleBlur,className:l(s),children:[r.jsx("option",{value:"EUR",children:"€ Euro"}),r.jsx("option",{value:"USD",children:"$ Dollar"}),r.jsx("option",{value:"GBP",children:"£ Livre sterling"})]})})}}),E?r.jsxs("div",{className:"rounded-md bg-amber-50 px-3 py-2 text-sm text-amber-900",children:[r.jsx("p",{className:"font-medium",children:"Corrigez les champs en rouge avant de publier le listing."}),r.jsx("ul",{className:"mt-2 list-disc space-y-1 pl-5 text-amber-900",children:v.map(({field:e,message:t},s)=>r.jsxs("li",{children:[r.jsxs("span",{className:"font-semibold",children:[g[e]??e??"Champ",":"," "]}),t]},`${e}-${s}`))})]}):null,b.intent&&r.jsx("p",{className:`rounded-md px-3 py-2 text-sm ${b.intent==="success"?"bg-emerald-100 text-emerald-800":"bg-rose-100 text-rose-800"}`,children:b.text}),r.jsx("div",{className:"flex flex-col gap-3 md:flex-row md:justify-end",children:r.jsx(a.Subscribe,{selector:e=>[e.isSubmitting],children:([e])=>r.jsx("button",{type:"submit",disabled:e||!d,className:"inline-flex items-center justify-center rounded-md bg-slate-900 px-6 py-2 text-white transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:bg-slate-400",children:e?"Création en cours...":d?"Publier le listing":"Connectez-vous pour publier"})})})]})]})}function N({label:x,required:m,error:d,children:g}){return r.jsxs("label",{className:"space-y-2 text-sm",children:[r.jsxs("span",{className:"flex items-center gap-1 text-slate-700",children:[x,m?r.jsx("span",{className:"text-xs font-semibold uppercase text-rose-600",children:"*"}):null]}),g,d?r.jsx("span",{className:"text-xs text-rose-600",children:d}):null]})}export{Q as component};
