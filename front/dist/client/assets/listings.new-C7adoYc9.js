import{r as n,j as t,h as M,L as W,i as $}from"./main--6Jdfoj8.js";import{a as G}from"./auth-client-D3uVBrLO.js";const C=b=>structuredClone(b);function H(b){const{validators:p,defaultValues:u,onSubmit:m}=b,h=n.useRef(p??{}),a=n.useRef(m),e=n.useRef(C(u)),[r,i]=n.useState(()=>C(e.current)),[o,V]=n.useState({}),k=n.useRef({}),[R,y]=n.useState({}),[T,E]=n.useState(!1),[L,F]=n.useState(0),B=n.useRef(null);n.useEffect(()=>{h.current=p??{}},[p]),n.useEffect(()=>{a.current=m},[m]);const j=n.useCallback(s=>{V(l=>{const d=s(l);return k.current=d,d})},[]),N=n.useCallback((s,l,d)=>{const x=h.current?.[s];if(!x)return[];const c=x(l,d??r);return c?[c]:[]},[r]),q=n.useCallback(()=>{const s=C(e.current);i(s),y({}),j(()=>({})),F(0)},[j]),O=n.useCallback((s,l)=>{i(d=>({...d,[s]:l}))},[]),z=n.useCallback(async s=>{s?.preventDefault();const l=r,d={};let x=!1;for(const c of Object.keys(l)){const v=N(c,l[c],l);v.length&&(x=!0,d[c]=v)}if(y(d),j(c=>{const v={...c};for(const w of Object.keys(l))v[w]=!0;return v}),F(c=>c+1),!x){E(!0);try{await a.current?.({value:l,formApi:B.current})}finally{E(!1)}}},[j,N,r]),P=({name:s,children:l})=>{const d=r[s],x=k.current[s]??!1,c=R[s]??[],v=()=>{j(g=>({...g,[s]:!0})),y(g=>({...g,[s]:N(s,r[s],r)}))},w=g=>{i(S=>{const D={...S,[s]:g};return k.current[s]&&y(I=>({...I,[s]:N(s,g,D)})),D})};return t.jsx(t.Fragment,{children:l({name:s,state:{value:d,meta:{isDirty:!Object.is(d,e.current[s]),isTouched:x,touchedErrors:x?c:[]}},handleBlur:v,handleChange:w,setValue:g=>{i(S=>({...S,[s]:g}))}})})},U=n.useMemo(()=>Object.keys(e.current).some(l=>!Object.is(r[l],e.current[l])),[r]),A={Field:P,handleSubmit:z,reset:q,setFieldValue:O,state:{values:r,errors:R,touched:o,isDirty:U,isSubmitting:T,submitCount:L}};return B.current=A,A}function J(b){const p=H(b),u=n.useRef(p);u.current=p;const m=({selector:r,children:i})=>{const o=r(u.current.state);return t.jsx(t.Fragment,{children:i(o)})},h=n.useRef(null),a=n.useRef(null);h.current||(h.current=(r=>u.current.Field(r))),a.current||(a.current=m);const e=n.useRef(null);return e.current?(Object.assign(e.current,p),e.current.Field=h.current,e.current.Subscribe=a.current):e.current={...p,Field:h.current,Subscribe:a.current},e.current}function X(){const b=M(),u=G.useSession().data?.user,[m,h]=n.useState({intent:null}),a=J({defaultValues:{title:"",shortDescription:"",pickupAddress:"",deliveryAddress:"",budget:"50",currency:"EUR",pickupWindowStart:"",pickupWindowEnd:""},validators:{title:e=>e.trim().length===0?"Le titre est requis.":void 0,pickupAddress:e=>e.trim().length===0?"Adresse de retrait requise.":void 0,deliveryAddress:e=>e.trim().length===0?"Adresse de livraison requise.":void 0,budget:e=>Number(e)>0?void 0:"Le budget doit être supérieur à 0.",pickupWindowStart:(e,r)=>{if(!e||!r.pickupWindowEnd)return;const i=Date.parse(e),o=Date.parse(r.pickupWindowEnd);return Number.isNaN(i)||Number.isNaN(o)?"Fenêtre de retrait invalide.":i<o?void 0:"Le début doit être antérieur à la fin."},pickupWindowEnd:(e,r)=>{if(!e||!r.pickupWindowStart)return;const i=Date.parse(r.pickupWindowStart),o=Date.parse(e);return Number.isNaN(i)||Number.isNaN(o)?"Fenêtre de retrait invalide.":o>i?void 0:"La fin doit être postérieure au début."}},onSubmit:async({value:e,formApi:r})=>{if(!u){h({intent:"error",text:"Veuillez vous connecter pour créer un listing."});return}h({intent:null});const i={title:e.title.trim(),shortDescription:e.shortDescription?.trim()||void 0,pickupAddress:e.pickupAddress.trim(),deliveryAddress:e.deliveryAddress.trim(),budget:Number(e.budget)||0,currency:e.currency,pickupWindowStart:e.pickupWindowStart||void 0,pickupWindowEnd:e.pickupWindowEnd||void 0},o=await $(i);h({intent:o.ok?"success":"error",text:o.message}),o.ok&&(r.reset(),setTimeout(()=>{b({to:"/listings"})},350))}});return t.jsxs("section",{className:"space-y-6 p-4",children:[t.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-slate-500 uppercase tracking-wide",children:"Nouveau listing"}),t.jsx("h1",{className:"text-2xl font-semibold",children:"Publier une livraison"})]}),t.jsx(W,{to:"/listings",className:"rounded-md border border-slate-300 px-4 py-2 text-slate-700 transition hover:bg-slate-50",children:"Retour aux listings"})]}),u?null:t.jsxs("div",{className:"rounded-md border border-amber-300 bg-amber-50 p-4 text-sm text-amber-900",children:["Vous devez être connecté pour publier une livraison. Rendez-vous sur"," ",t.jsx(W,{to:"/auth",className:"font-medium underline",children:"la page d’authentification"})," ","pour créer un compte ou vous connecter."]}),t.jsxs("form",{onSubmit:e=>{a.handleSubmit(e)},className:"space-y-6 rounded-lg border border-slate-200 bg-white p-6 shadow-sm",children:[t.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[t.jsx(a.Field,{name:"title",children:e=>t.jsx(f,{label:"Titre",required:!0,error:e.state.meta.touchedErrors[0],children:t.jsx("input",{type:"text",value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2",placeholder:"Colis Bordeaux → Toulouse"})})}),t.jsx(a.Field,{name:"budget",children:e=>t.jsx(f,{label:"Budget estimé (EUR)",required:!0,error:e.state.meta.touchedErrors[0],children:t.jsx("input",{type:"number",min:1,step:5,value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2"})})})]}),t.jsx(a.Field,{name:"shortDescription",children:e=>t.jsx(f,{label:"Description rapide",children:t.jsx("textarea",{value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,rows:3,className:"w-full rounded-md border border-slate-300 px-3 py-2",placeholder:"Précisez la nature du colis, sa fragilité, les documents à fournir..."})})}),t.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[t.jsx(a.Field,{name:"pickupAddress",children:e=>t.jsx(f,{label:"Adresse de retrait",required:!0,error:e.state.meta.touchedErrors[0],children:t.jsx("input",{type:"text",value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2",placeholder:"12 Rue de la République, 69002 Lyon"})})}),t.jsx(a.Field,{name:"deliveryAddress",children:e=>t.jsx(f,{label:"Adresse de livraison",required:!0,error:e.state.meta.touchedErrors[0],children:t.jsx("input",{type:"text",value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2",placeholder:"5 Rue Sainte-Catherine, 33000 Bordeaux"})})})]}),t.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[t.jsx(a.Field,{name:"pickupWindowStart",children:e=>t.jsx(f,{label:"Début de fenêtre de retrait",children:t.jsx("input",{type:"datetime-local",value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2"})})}),t.jsx(a.Field,{name:"pickupWindowEnd",children:e=>t.jsx(f,{label:"Fin de fenêtre de retrait",children:t.jsx("input",{type:"datetime-local",value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2"})})})]}),t.jsx(a.Field,{name:"currency",children:e=>t.jsx(f,{label:"Devise",children:t.jsxs("select",{value:e.state.value,onChange:r=>e.handleChange(r.target.value),onBlur:e.handleBlur,className:"w-full rounded-md border border-slate-300 px-3 py-2",children:[t.jsx("option",{value:"EUR",children:"€ Euro"}),t.jsx("option",{value:"USD",children:"$ Dollar"}),t.jsx("option",{value:"GBP",children:"£ Livre sterling"})]})})}),m.intent&&t.jsx("p",{className:`rounded-md px-3 py-2 text-sm ${m.intent==="success"?"bg-emerald-100 text-emerald-800":"bg-rose-100 text-rose-800"}`,children:m.text}),t.jsx("div",{className:"flex flex-col gap-3 md:flex-row md:justify-end",children:t.jsx(a.Subscribe,{selector:e=>[e.isSubmitting],children:([e])=>t.jsx("button",{type:"submit",disabled:e||!u,className:"inline-flex items-center justify-center rounded-md bg-slate-900 px-6 py-2 text-white transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:bg-slate-400",children:e?"Création en cours...":u?"Publier le listing":"Connectez-vous pour publier"})})})]})]})}function f({label:b,required:p,error:u,children:m}){return t.jsxs("label",{className:"space-y-2 text-sm",children:[t.jsxs("span",{className:"flex items-center gap-1 text-slate-700",children:[b,p?t.jsx("span",{className:"text-xs font-semibold uppercase text-rose-600",children:"*"}):null]}),m,u?t.jsx("span",{className:"text-xs text-rose-600",children:u}):null]})}export{X as component};
