import{d as D,u as A,r as d,j as e,L as y,e as E,l as w,f as k}from"./main-CYDXynsJ.js";function M(){const{listings:s,needsClientFetch:r}=D.useLoaderData(),c=A(),[x,l]=d.useState(s);d.useEffect(()=>{l(s)},[s]);const p=(i,h)=>{l(u=>u.map(m=>m.id===i?{...m,...h}:m))};return d.useEffect(()=>{r&&c.invalidate()},[r,c]),r?e.jsx("section",{className:"space-y-6 p-4",children:e.jsx("p",{className:"text-sm text-slate-500",children:"Chargement des listings…"})}):e.jsxs("section",{className:"space-y-6 p-4",children:[e.jsxs("header",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500 uppercase tracking-wide",children:"Vos livraisons"}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Mes listings"})]}),e.jsx(y,{to:"/listings/new",className:"rounded-md bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800",children:"Créer un listing"})]}),e.jsx("div",{className:"rounded-md border border-dashed border-slate-300 bg-slate-50 p-4 text-sm text-slate-600",children:"Les filtres et critères de recherche arriveront bientôt. Vous pourrez alors affiner les listings par statut, trajet ou fenêtre de retrait."}),x.length===0?e.jsx(F,{}):e.jsx("ul",{className:"space-y-4",children:x.map(i=>e.jsx(q,{listing:i,onUpdate:h=>p(i.id,h)},i.id))})]})}function F(){return e.jsxs("div",{className:"rounded-md border border-slate-200 bg-white p-8 text-center",children:[e.jsx("p",{className:"text-lg font-medium text-slate-700",children:"Aucun listing pour le moment."}),e.jsx("p",{className:"mt-2 text-sm text-slate-500",children:"Ajoutez votre première livraison pour commencer à recevoir des demandes de drivers."}),e.jsx("div",{className:"mt-4",children:e.jsx(y,{to:"/listings/new",className:"inline-flex rounded-md bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800",children:"Nouveau listing"})})]})}function q({listing:s,onUpdate:r}){const[c,x]=d.useState(!1),[l,p]=d.useState(s),[i,h]=d.useState(!1),[u,m]=d.useState([]),[f,j]=d.useState(!1),[g,b]=d.useState(null),[v,N]=d.useState(null);d.useEffect(()=>{p(s)},[s]);const o=(t,a)=>{p(n=>({...n,[t]:a}))},C=t=>{o("budget",t===""?void 0:Number(t))},R=t=>{t.preventDefault(),r(l),x(!1)},S=()=>{p(s),x(!1)},L=async()=>{const t=!i;if(h(t),!(!t||u.length>0)){j(!0),b(null);try{const a=await k(s.id);m(a)}catch(a){const n=a instanceof Error?a.message:"Impossible de charger les offres pour ce listing.";b(n)}finally{j(!1)}}};return e.jsxs("li",{className:"rounded-lg border border-slate-200 bg-white p-4 shadow-sm",children:[e.jsxs("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-slate-900",children:s.title}),s.shortDescription&&e.jsx("p",{className:"text-sm text-slate-500",children:s.shortDescription})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(B,{status:s.status}),e.jsx("button",{type:"button",onClick:()=>x(t=>!t),className:"rounded-md border border-slate-300 px-3 py-1 text-sm font-medium text-slate-700 transition hover:bg-slate-50",children:c?"Fermer":"Modifier"})]})]}),e.jsxs("div",{className:"mt-4 grid gap-3 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Retrait"}),e.jsx("p",{className:"text-sm text-slate-800",children:s.pickupAddress}),e.jsx("p",{className:"text-xs text-slate-500",children:$(s.pickupWindow)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Livraison"}),e.jsx("p",{className:"text-sm text-slate-800",children:s.deliveryAddress})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-slate-500",children:"Budget estimé"}),e.jsx("p",{className:"text-lg font-semibold text-slate-900",children:I(s)}),e.jsxs("p",{className:"text-xs text-slate-500",children:["Créé le ",new Date(s.createdAt).toLocaleDateString("fr-FR")]})]})]}),!!s.deliveryRequestCount&&e.jsxs("div",{className:"mt-4 rounded-md border border-slate-200 p-3",children:[e.jsx("button",{type:"button",onClick:L,className:"text-sm font-medium text-slate-700 underline-offset-2 hover:underline",children:i?"Masquer les offres des livreurs":`Voir les ${s.deliveryRequestCount} offre${s.deliveryRequestCount&&s.deliveryRequestCount>1?"s":""}`}),i&&e.jsxs("div",{className:"mt-3 space-y-2",children:[f&&e.jsx("p",{className:"text-sm text-slate-500",children:"Chargement des offres…"}),g&&e.jsx("p",{className:"text-sm text-rose-600",children:g}),!f&&!g&&u.length===0&&e.jsx("p",{className:"text-sm text-slate-500",children:"Aucun livreur n’a encore postulé."}),!f&&u.length>0&&e.jsx("ul",{className:"space-y-2",children:u.map(t=>e.jsxs("li",{className:"rounded border border-slate-200 p-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-slate-900",children:t.driverName??"Livreur"}),e.jsx("p",{className:"text-slate-500",children:t.driverEmail})]}),e.jsxs("p",{className:"mt-1 text-xs text-slate-500",children:["Demande reçue le"," ",new Date(t.createdAt).toLocaleString("fr-FR")]}),t.status==="pending"&&e.jsx("button",{type:"button",onClick:async()=>{N(t.id),b(null);try{await E(s.id,t.id),m(a=>a.map(n=>n.id===t.id?{...n,status:"accepted"}:n.status==="pending"?{...n,status:"declined"}:n)),r({status:"assigned"})}catch(a){const n=a instanceof Error?a.message:"Impossible d’accepter cette offre.";b(n)}finally{N(null)}},disabled:v===t.id,className:"mt-2 rounded border border-emerald-600 px-3 py-1 text-xs font-semibold text-emerald-700 transition hover:bg-emerald-50 disabled:cursor-not-allowed disabled:opacity-60",children:v===t.id?"Validation…":"Accepter ce livreur"}),t.status==="accepted"&&e.jsx("p",{className:"mt-2 text-xs font-semibold uppercase text-emerald-600",children:"Livreur accepté"})]},t.id))})]})]}),c&&e.jsxs("form",{className:"mt-4 space-y-4 border-t border-slate-200 pt-4",onSubmit:R,children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Titre",e.jsx("input",{type:"text",className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.title,onChange:t=>o("title",t.target.value)})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Budget",e.jsx("input",{type:"number",className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.budget??"",onChange:t=>C(t.target.value)})]})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Description courte",e.jsx("input",{type:"text",className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.shortDescription??"",onChange:t=>o("shortDescription",t.target.value)})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Adresse de retrait",e.jsx("input",{type:"text",className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.pickupAddress,onChange:t=>o("pickupAddress",t.target.value)})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Adresse de livraison",e.jsx("input",{type:"text",className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.deliveryAddress,onChange:t=>o("deliveryAddress",t.target.value)})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"text-sm text-slate-700",children:["Devise",e.jsx("input",{type:"text",className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.currency??"",onChange:t=>o("currency",t.target.value)})]}),e.jsxs("label",{className:"text-sm text-slate-700",children:["Statut",e.jsx("select",{className:"mt-1 w-full rounded border border-slate-200 px-3 py-2 text-sm",value:l.status,onChange:t=>o("status",t.target.value),children:Object.entries(w).map(([t,a])=>e.jsx("option",{value:t,children:a},t))})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"submit",className:"rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white transition hover:bg-slate-800",children:"Enregistrer"}),e.jsx("button",{type:"button",onClick:S,className:"rounded-md border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50",children:"Annuler"})]})]})]})}function B({status:s}){const r=w[s],c={draft:"bg-slate-200 text-slate-800",published:"bg-emerald-100 text-emerald-700",assigned:"bg-indigo-100 text-indigo-700",ready_for_pickup:"bg-yellow-100 text-yellow-800",in_transit:"bg-blue-100 text-blue-800",delivered:"bg-green-100 text-green-700",cancelled:"bg-rose-100 text-rose-700",disputed:"bg-orange-100 text-orange-700",archived:"bg-slate-100 text-slate-500"};return e.jsx("span",{className:`inline-flex items-center rounded-full px-3 py-1 text-sm font-medium ${c[s]}`,children:r})}function I(s){return!s.budget||!s.currency?"À définir":new Intl.NumberFormat("fr-FR",{style:"currency",currency:s.currency,maximumFractionDigits:0}).format(s.budget)}function $(s){if(!s)return"Fenêtre à confirmer";const r=new Intl.DateTimeFormat("fr-FR",{weekday:"short",hour:"2-digit",minute:"2-digit"});return`${r.format(new Date(s.start))} → ${r.format(new Date(s.end))}`}export{M as component};
